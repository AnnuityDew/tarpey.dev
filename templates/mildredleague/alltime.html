{% extends 'base.html' %}
  
{% block title %}mildredleague stats{% endblock %}

{% block style %}
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='mildredleague/css/mildredleague.css') }}">
{% endblock %}

{% block java %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="{{ url_for('static', filename='mildredleague/js/mildredleague.js') }}"></script>
{% endblock %}

{% block header %}mildredleague stats{% endblock %}

{% block content %}
<p>
  Scroll down for some visuals that tell the all-time story of Mildred League...
</p>

<p>
  (Best viewed in landscape!)
</p>

<div class="plots" id="matchup_heatmap">
  <script>
    MATCHUPS = document.getElementById('matchup_heatmap')
    // pull x_data, y_data, z_data, and color data from Python
    var xData = {{x_opponents | safe}};
    var yData = {{y_winners | safe}};
    var zData = {{z_matchup_data | safe}};
    // replace z data -1s with nulls
    for (var i = 0; i < zData.length; i++)
      for (var j = 0; j < zData[i].length; j++)
        if (zData[i][j] == -1)
          zData[i][j] = null;
    var colorData = {{matchup_colors | safe}};
    var hoverData = {{hover_data | safe}};
    var plotData = [{
      x: xData,
      y: yData,
      z: zData,
      customdata: hoverData,
      type: 'heatmap',
      colorscale: colorData,
      hovertemplate: 'Winner: %{y}<br>Opponent: %{x}<br>Win %: %{z:.3f}<br>Games: %{customdata} <extra></extra>',
    }];  
    var layout = {
      template: tarpeydevDefault,
      title: "Matchup Win Percentage (Active Teams)",
      margin: {l:120, r:60, t:150, autoexpand: true},
      xaxis: {
        showgrid: false,
        showline: false,
        ticks: '',
        side: 'top',
      },
      yaxis: {
        title: 'Winner',
        showgrid: false,
        showline: false,
        ticks: '',
      },
      annotations: [],
    };
    // begin loop to push each annotation into annotations
    for ( var i = 0; i < yData.length; i++ ) {
      for ( var j = 0; j < xData.length; j++ ) {
        var currentValue = zData[i][j];
        // replace z data 0s with nulls
        if (currentValue < .20 || currentValue > .80) {
          var postedAnnotation = '';
          var chosenColor = '#FFFFFF';
        } else {
          var postedAnnotation = currentValue;
          var chosenColor = '#000000';
        };
        var result = {
          xref: 'x1',
          yref: 'y1',
          x: xData[j],
          y: yData[i],
          text: parseFloat(postedAnnotation*100).toFixed(1)+"%",
          font: {
            size: 10,
            color: chosenColor,
          },
          showarrow: false,
        };
        layout.annotations.push(result);
      }
    }
    var config = {responsive: true};
    Plotly.newPlot(MATCHUPS, plotData, layout, config);
  </script>
</div>

<div class="plots" id="ranking_heatmap">
  <script>
    // ranking heatmap object
    RANKINGS = document.getElementById('ranking_heatmap')
    // pull x_data, y_data, z_data, and color data from Python
    var xData = {{x_seasons | safe}};
    var yData = {{y_ranking_names | safe}};
    var zData = {{z_rankings | safe}};
    var colorData = {{heatmap_colors | safe}};
    // replace z data 0s with nulls
    for (var i = 0; i < zData.length; i++)
      for (var j = 0; j < zData[i].length; j++)
        if (zData[i][j] == 0)
          zData[i][j] = null;
    // plotData constructed all in one go for a heatmap.
    // annotations will be looped however
    var plotData = [{
      x: xData,
      y: yData,
      z: zData,
      type: 'heatmap',
      colorscale: colorData,
      showscale: false,
    }];
    var layout = {
      template: tarpeydevDefault,
      title: 'Placements by Season',
      margin: {l:120, r:60},
      xaxis: {
        showgrid: false,
        showline: false,
        side: 'top',
      },
      yaxis: {
        showgrid: false,
        showline: false,
      },
      annotations: [],
      plot_bgcolor: 'rgba(255,255,255,0.0)',
    };
    // begin loop to push each annotation into annotations
    for ( var i = 0; i < yData.length; i++ ) {
      for ( var j = 0; j < xData.length; j++ ) {
        var currentValue = zData[i][j];
        // replace z data 0s with nulls
        if (currentValue == null) {
          var postedAnnotation = '';
        } else {
          var postedAnnotation = currentValue;
        };
        if (currentValue <= 3 || currentValue >= 12) {
          var chosenColor = '#FFFFFF';
        } else {
          var chosenColor = '#000000';
        };
        var result = {
          xref: 'x1',
          yref: 'y1',
          x: xData[j],
          y: yData[i],
          text: postedAnnotation,
          showarrow: false,
          font: {
            color: chosenColor,
          },
        };
        layout.annotations.push(result);
      }
    }
    var config = {responsive: true};
    Plotly.newPlot(RANKINGS, plotData, layout, config);
  </script>
</div>

<div class="plots" id="win_bars">
  <script>
    // win bars object
    TOTALWINS = document.getElementById('win_bars')
    // pull x_data, y_data, and color data from Python
    var xData = {{ x_data_bars | safe }};
    var yData = {{ y_data_bars | safe }};
    var barColors = {{ bar_colors | safe }};
    // plotData needs to be an array of valid traces, so
    // here's a loop that constructs the traces from
    // x_data and y_data, then pushes it into plotData
    // bars are colored at the trace level and not
    // the layout level
    var plotData = [];
    for ( var i = 0; i < xData.length; i ++ ) {
      var trace = {
        x: [xData[i]],
        y: [yData[i]],
        name: yData[i],
        type: 'bar',
        orientation: 'h',
        marker: {
          color: barColors[i],
        }
      };
      plotData.push(trace);
    };
    var layout = {
      template: tarpeydevDefault,
      title: "Regular Season Win Totals",
      margin: {l:120, r:60},
      xaxis:{title:null},
      yaxis:{title:null},
      showlegend: false,
      hovermode: 'closest',
    };
    var config = {responsive: true};
    Plotly.newPlot(TOTALWINS, plotData, layout, config);
  </script>
</div>
{% endblock %}